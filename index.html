// ======= SUPABASE =======
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const SUPABASE_URL = "https://krjwqagkjuzrpxianvnu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtyandxYWdranV6cnB4aWFudm51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NDY4NjEsImV4cCI6MjA3NDMyMjg2MX0.vdIMVgAciBhAweV4CGjEXq-fuo2xRm0qSssl4JhoErQ";
export const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
const TABLE = "instituciones";

// ======= UI =======
const kpiTotal = document.getElementById("kpiTotal");
const kpiMatriz = document.getElementById("kpiMatriz");
const kpiEst = document.getElementById("kpiEst");
const kpiSost = document.getElementById("kpiSost");
const provSelect = document.getElementById("provSelect");
const cantSelect = document.getElementById("cantSelect");
const parrSelect = document.getElementById("parrSelect");
const sostSelect = document.getElementById("sostSelect");
const tipoSelect = document.getElementById("tipoSelect");
const amieInput = document.getElementById("amieInput");
const searchBtn = document.getElementById("searchBtn");
const clearBtn = document.getElementById("clearBtn");
const tbody = document.querySelector("#tbl tbody");
const pageSizeSel = document.getElementById?.("pageSize");
const prevPageBtn = document.getElementById?.("prevPage");
const nextPageBtn = document.getElementById?.("nextPage");
const pageInfo = document.getElementById?.("pageInfo");

// ======= MAPA =======
let map = L.map("map", { zoomControl:true }).setView([-1.8312, -78.1834], 6);
const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19, attribution: "&copy; OpenStreetMap"
}).addTo(map);
const esriSat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 19, attribution: "Tiles © Esri, Maxar, Earthstar Geographics, etc." }
);
L.control.layers({ "OSM": osm, "Satélite (Esri)": esriSat }, {}, { collapsed:true }).addTo(map);

// Cluster + red dot
let clusterLayer = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:50 });
map.addLayer(clusterLayer);
const redDotIcon = L.divIcon({ className:"red-dot", html:"", iconSize:[10,10] });

// ======= COORDS BAR (sin plugin, nativo) =======
const coordsBar = document.getElementById("coordsBar");
function fmt(n){ return (Math.round(n*1e6)/1e6).toFixed(6); }
map.on("mousemove", (e)=>{ coordsBar.textContent = `Lat: ${fmt(e.latlng.lat)}  Lon: ${fmt(e.latlng.lng)} (click para copiar)`; });
coordsBar?.addEventListener("click", ()=>{
  navigator.clipboard?.writeText(coordsBar.textContent.replace(" (click para copiar)",""));
});

// (si quieres usar tu plugin latlontools real en lugar de la barra nativa, descomenta esto)
// if (window.LatLonTools) { LatLonTools.addTo(map); }

// ======= STATE =======
let currentData = [];
let currentPage = 1;
let pageSize = parseInt(pageSizeSel?.value || "25", 10) || 25;

// ======= HELPERS =======
function applyFilters(q){
  if(provSelect.value) q = q.eq("provincia", provSelect.value);
  if(cantSelect.value) q = q.eq("canton", cantSelect.value);
  if(parrSelect.value) q = q.eq("parroquia", parrSelect.value);
  if(sostSelect.value) q = q.eq("sostenimiento", sostSelect.value);
  if(tipoSelect.value) q = q.eq("tipo", tipoSelect.value);
  return q;
}

function uniqueClean(values){
  return [...new Set(values.map(v => (v ?? "").toString().trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es'));
}

async function getDistinct(field){
  const { data, error } = await supabase
    .from(TABLE)
    .select(field)
    .not(field, "is", null)
    .neq(field, "")
    .order(field, { ascending:true })
    .limit(20000);
  if(error){ console.error(error); return []; }
  return uniqueClean((data||[]).map(r => r[field]));
}

// ======= LOAD FILTER OPTIONS =======
// Provincia desde GeoJSON + fallback Supabase (unión de ambos)
async function loadProvincesFromGeoJSON(){
  try{
    const res = await fetch("provincias.geojson", { cache:"no-store" });
    const gj = await res.json();
    // intenta estas propiedades comunes
    const names = gj.features.map(f =>
      (f.properties.DPA_DESPRO || f.properties.nombre || f.properties.NAME_1 || f.properties.provincia || "").toString().trim()
    );
    return uniqueClean(names);
  }catch(e){
    console.warn("No se pudo leer provincias.geojson:", e);
    return [];
  }
}

async function loadFilterOptions(){
  // Provincias
  const [provGeo, provDb] = await Promise.all([loadProvincesFromGeoJSON(), getDistinct("provincia")]);
  const provAll = uniqueClean([...provGeo, ...provDb]);
  provAll.forEach(v => { const o=document.createElement("option"); o.value=v; o.textContent=v; provSelect.appendChild(o); });

  // Cantones / Parroquias desde DB (limpios)
  (await getDistinct("canton")).forEach(v => { const o=document.createElement("option"); o.value=v; o.textContent=v; cantSelect.appendChild(o); });
  (await getDistinct("parroquia")).forEach(v => { const o=document.createElement("option"); o.value=v; o.textContent=v; parrSelect.appendChild(o); });

  // Sostenimiento desde DB, orden preferente
  const sost = (await getDistinct("sostenimiento")).map(s => s.toUpperCase());
  const order = ["FISCAL","FISCOMISIONAL","PARTICULAR","MUNICIPAL"];
  const seen = new Set();
  const sorted = [...order.filter(x => sost.includes(x)), ...sost.filter(s => !order.includes(s) && !seen.has(s) && seen.add(s))];
  sorted.forEach(v => { const o=document.createElement("option"); o.value=v; o.textContent=v; sostSelect.appendChild(o); });
}

// ======= KPIs =======
async function updateKPIs(){
  let q = applyFilters(supabase.from(TABLE).select("*",{count:"exact", head:true}));
  const { count: total } = await q; kpiTotal.textContent = total ?? "0";

  let qm = applyFilters(supabase.from(TABLE).select("*",{count:"exact", head:true}).eq("tipo","MATRIZ"));
  const { count: cm } = await qm; kpiMatriz.textContent = cm ?? "0";

  let qe = applyFilters(supabase.from(TABLE).select("*",{count:"exact", head:true}).eq("tipo","ESTABLECIMIENTO"));
  const { count: ce } = await qe; kpiEst.textContent = ce ?? "0";

  let qs = applyFilters(supabase.from(TABLE).select("sostenimiento"));
  const { data: ds, error: es } = await qs;
  if(!es){ const setS = new Set((ds||[]).map(r => (r.sostenimiento||"").toString().trim()).filter(Boolean)); kpiSost.textContent = setS.size.toString(); }
}

// ======= QUERY + RENDER =======
async function refreshData(){
  let q = supabase.from(TABLE).select("amie,nombre_ie,tipo,sostenimiento,provincia,canton,parroquia,lat,lon").limit(5000);
  q = applyFilters(q);

  const term = amieInput.value.trim();
  if(term){ /^[0-9A-Z]+$/.test(term) ? q = q.ilike("amie", `%${term}%`) : q = q.ilike("nombre_ie", `%${term}%`); }

  const { data, error } = await q;
  if(error){ console.error(error); return; }
  currentData = data || [];
  currentPage = 1;

  renderMap(currentData);
  renderTablePage();
  updateKPIs();
}

function renderMap(rows){
  clusterLayer.clearLayers();
  const pts = [];
  rows.filter(r => typeof r.lat==="number" && typeof r.lon==="number" && !Number.isNaN(r.lat) && !Number.isNaN(r.lon))
      .forEach(r => {
        const m = L.marker([r.lat, r.lon], { icon: redDotIcon })
          .bindPopup(`<b>${r.nombre_ie||""}</b><br>AMIE: ${r.amie||""}<br>${r.provincia||""} / ${r.canton||""}`);
        clusterLayer.addLayer(m);
        pts.push([r.lat, r.lon]);
      });
  if(pts.length){ map.fitBounds(L.latLngBounds(pts).pad(0.2)); }
}

function renderTablePage(){
  if(!pageSizeSel){ // si tu template no tiene paginación, render simple
    tbody.innerHTML = "";
    (currentData||[]).forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.amie||""}</td><td>${r.nombre_ie||""}</td><td>${r.tipo||""}</td>
                      <td>${r.sostenimiento||""}</td><td>${r.provincia||""}</td><td>${r.canton||""}</td><td>${r.parroquia||""}</td>`;
      tbody.appendChild(tr);
    });
    return;
  }
  const total = currentData.length;
  pageSize = parseInt(pageSizeSel.value,10)||25;
  const pageCount = Math.max(1, Math.ceil(total / pageSize));
  currentPage = Math.min(Math.max(1,currentPage), pageCount);
  const start = (currentPage-1)*pageSize;
  const slice = currentData.slice(start, start+pageSize);

  tbody.innerHTML = "";
  slice.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.amie||""}</td><td>${r.nombre_ie||""}</td><td>${r.tipo||""}</td>
                    <td>${r.sostenimiento||""}</td><td>${r.provincia||""}</td><td>${r.canton||""}</td><td>${r.parroquia||""}</td>`;
    tbody.appendChild(tr);
  });

  pageInfo.textContent = `Página ${currentPage}/${pageCount}`;
  prevPageBtn.disabled = currentPage<=1;
  nextPageBtn.disabled = currentPage>=pageCount;
}

// ======= EVENTS =======
searchBtn.addEventListener("click", refreshData);
clearBtn.addEventListener("click", ()=>{
  provSelect.value=""; cantSelect.value=""; parrSelect.value=""; sostSelect.value=""; tipoSelect.value="";
  amieInput.value=""; refreshData();
});
[provSelect,cantSelect,parrSelect,sostSelect,tipoSelect].forEach(el => el.addEventListener("change", refreshData));

prevPageBtn?.addEventListener("click", ()=>{ currentPage--; renderTablePage(); });
nextPageBtn?.addEventListener("click", ()=>{ currentPage++; renderTablePage(); });
pageSizeSel?.addEventListener("change", ()=>{ currentPage=1; renderTablePage(); });

// ======= INIT =======
(async function init(){
  await loadFilterOptions();
  await refreshData();
})();
